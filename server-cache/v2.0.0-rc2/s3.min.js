AWS.S3=AWS.Service.defineService("s3",["2006-03-01"],{initialize:function e(t){AWS.Service.prototype.initialize.call(this,t);this.setEndpoint((t||{}).endpoint,t)},setupRequestListeners:function t(e){e.addListener("build",this.addContentType);e.addListener("build",this.populateURI);e.addListener("build",this.computeContentMd5);e.removeListener("validate",AWS.EventListeners.Core.VALIDATE_REGION);e.addListener("extractError",this.extractError);e.addListener("extractData",this.extractData)},populateURI:function r(e){var t=e.httpRequest;var r=e.params.Bucket;if(r){if(!e.service.pathStyleBucketName(r)){t.endpoint.host=t.endpoint.hostname=r+"."+t.endpoint.hostname;t.virtualHostedBucket=r;t.path=t.path.replace(new RegExp("^/"+r),"");if(t.path[0]!=="/"){t.path="/"+t.path}}}},addContentType:function n(e){var t=e.httpRequest;if(!t.headers["Content-Type"]){t.headers["Content-Type"]="application/octet-stream"}if(AWS.util.isBrowser()&&navigator.userAgent.match(/Firefox/)){if(!t.headers["Content-Type"].match(/;/)){var r="; charset=UTF-8";t.headers["Content-Type"]+=r}}},computableChecksumOperations:{putBucketCors:true,putBucketLifecycle:true,putBucketTagging:true,deleteObjects:true},willComputeChecksums:function i(e){if(this.computableChecksumOperations[e.operation])return true;if(!this.config.computeChecksums)return false;if(!Buffer.isBuffer(e.httpRequest.body)&&typeof e.httpRequest.body!=="string"){return false}var t=e.service.api.operations[e.operation].input.members;if(t.ContentMD5&&!e.params.ContentMD5)return true},computeContentMd5:function a(e){if(e.service.willComputeChecksums(e)){var t=AWS.util.crypto.md5(e.httpRequest.body,"base64");e.httpRequest.headers["Content-MD5"]=t}},pathStyleBucketName:function o(e){if(this.config.s3ForcePathStyle)return true;if(this.dnsCompatibleBucketName(e)){return this.config.sslEnabled&&e.match(/\./)?true:false}else{return true}},dnsCompatibleBucketName:function s(e){var t=e;var r=new RegExp(/^[a-z0-9][a-z0-9\.\-]{1,61}[a-z0-9]$/);var n=new RegExp(/(\d+\.){3}\d+/);var i=new RegExp(/\.\./);return t.match(r)&&!t.match(n)&&!t.match(i)?true:false},escapePathParam:function u(e){return AWS.util.uriEscapePath(String(e))},successfulResponse:function p(e){var t=e.request;var r=e.httpResponse;if(t.operation==="completeMultipartUpload"&&r.body.toString().match("<Error>"))return false;else return r.statusCode<300},retryableError:function c(e,t){if(t.operation=="completeMultipartUpload"&&e.statusCode===200){return true}else{var r=AWS.Service.prototype.retryableError;return r.call(this,e,t)}},extractData:function d(e){var t=e.request;if(t.operation==="getBucketLocation"){var r=e.httpResponse.body.toString().match(/>(.+)<\/Location/);if(r){delete e.data["_"];e.data.LocationConstraint=r[1]}}},extractError:function h(e){var t={304:"NotModified",403:"Forbidden",400:"BadRequest",404:"NotFound"};var r=e.httpResponse.statusCode;var n=e.httpResponse.body;if(t[r]&&n.length===0){e.error=AWS.util.error(new Error,{code:t[e.httpResponse.statusCode],message:null})}else{var i=new AWS.XML.Parser({}).parse(n.toString());e.error=AWS.util.error(new Error,{code:i.Code||r,message:i.Message||null})}},setEndpoint:function l(e){if(e){this.endpoint=new AWS.Endpoint(e,this.config)}else if(this.config.region&&this.config.region!=="us-east-1"){var t="s3-"+this.config.region+".amazonaws.com";this.endpoint=new AWS.Endpoint(t)}else{this.endpoint=new AWS.Endpoint(this.api.globalEndpoint,this.config)}},getSignedUrl:function f(e,t,r){var n=t.Expires||900;delete t.Expires;var i=require("url");var a=["validate","build","sign"];var o=this.makeRequest(e,t);var s="presigned-expires";function u(){delete o.httpRequest.headers["User-Agent"];delete o.httpRequest.headers["X-Amz-User-Agent"];o.httpRequest.headers[s]=parseInt(AWS.util.date.unixTimestamp()+n,10).toString()}function p(){var e={};AWS.util.each(o.httpRequest.headers,function(t,r){if(t===s)t="Expires";e[t]=r});delete o.httpRequest.headers[s];var t=e["Authorization"].split(":");delete e["Authorization"];delete e["Host"];e["AWSAccessKeyId"]=t[0].split(" ")[1];e["Signature"]=t[1];var r=o.httpRequest.endpoint;var n=i.parse(o.httpRequest.path);var a=AWS.util.queryParamsToString(e);r.pathname=n.pathname;r.search=!n.search?a:n.search+"&"+a}o.on("build",u);o.on("sign",p);o.removeListener("build",this.addContentType);if(!t.Body){o.removeListener("build",this.computeContentMd5)}if(r){o.emitEvents(a,new AWS.Response(o),function(e){if(e)r(e,null);else r(null,i.format(o.httpRequest.endpoint))})}else{AWS.util.arrayEach(a,function(e){o.emitEvent(e,[o])});return i.format(o.httpRequest.endpoint)}}});AWS.S3.prototype.createBucket=function m(e,t){if(!e)e={};var r=this.endpoint.hostname;if(r!=this.api.globalEndpoint&&!e.CreateBucketConfiguration){e.CreateBucketConfiguration={LocationConstraint:this.config.region}}return this.makeRequest("createBucket",e,t)};